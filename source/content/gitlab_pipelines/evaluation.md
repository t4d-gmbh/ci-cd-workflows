## {octicon}`workflow` Workflow Evaluation

{% raw %}

GitLab evaluates a pipeline file (`.gitlab-ci.yml`) in a similar way to GitHub Actions, by parsing the YAML file structure and executing jobs based on predefined rules and stages. Here’s an overview:

### 1. **Parsing and Loading the Pipeline File**
- GitLab reads the `.gitlab-ci.yml` file in the root of the repository.
- The YAML structure defines stages, jobs, scripts, and rules for when and how to execute them.

### 2. **Pipeline Triggering**
- Pipelines are triggered based on specific events, such as commits, merges, or schedules.
- The `only` and `except` keywords define when a job runs, based on branches, tags, or specific pipeline triggers.

### 3. **Evaluating Variables**
GitLab uses different types of variables within the pipeline, including predefined, user-defined, and environment variables.

#### **Predefined GitLab Variables**
GitLab provides a set of predefined variables that contain information about the repository, pipeline, and job context. These variables are available during pipeline execution:

- **`CI_PROJECT_NAME`**: The project’s name (e.g., `my-repo`).
- **`CI_COMMIT_REF_NAME`**: The branch or tag name for which the pipeline runs.
- **`CI_JOB_STAGE`**: The stage the job is running in.

These variables are evaluated based on the repository state **at the time of the pipeline trigger**.

```yaml
stages:
  - build

build-job:
  stage: build
  script:
    - echo "Project: $CI_PROJECT_NAME"
    - echo "Branch: $CI_COMMIT_REF_NAME"
```

#### **User-Defined Variables**
- You can define custom variables at different levels: in the `.gitlab-ci.yml` file, in the GitLab project or group settings, or during pipeline runtime.
- These variables are referenced in jobs using `$VARIABLE_NAME`.

```yaml
variables:
  MY_CUSTOM_VAR: "Hello from GitLab"

stages:
  - test

test-job:
  stage: test
  script:
    - echo $MY_CUSTOM_VAR
```

#### **Environment Variables**
- **Environment variables** are defined either at the job level or globally for all jobs.
- They can also be defined in the GitLab UI under project or group settings.

```yaml
job_with_env:
  stage: test
  script:
    - echo "Running on environment: $MY_ENV"
  environment:
    name: production
```

### 4. **Evaluating Job Conditions and Rules**
GitLab allows jobs to be conditionally executed based on rules or conditions. These conditions can be defined with:

- **`only` / `except`**: Specifies which branches, tags, or conditions to include or exclude.
- **`rules`**: Allows more complex conditions based on expressions, variables, and more.

```yaml
stages:
  - deploy

deploy-job:
  stage: deploy
  script:
    - echo "Deploying..."
  only:
    - main
```

#### **Using `rules` for Conditional Execution**
You can use `rules` for more complex logic to define when a job should run:

```yaml
deploy-job:
  stage: deploy
  script:
    - echo "Deploying..."
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_TAG'
```

### 5. **Stages and Job Execution**
- Jobs are grouped into **stages**. All jobs in a stage must complete successfully before the next stage starts.
- Variables are evaluated when the job begins execution.

```yaml
stages:
  - build
  - test
  - deploy

build-job:
  stage: build
  script:
    - echo "Building..."

test-job:
  stage: test
  script:
    - echo "Testing..."

deploy-job:
  stage: deploy
  script:
    - echo "Deploying..."
```

### 6. **Secrets and Secure Variables**
- GitLab provides a **CI/CD variables** section in the project settings where you can store secure values (e.g., tokens, API keys).
- These values can be injected into the pipeline using `$VARIABLE_NAME`.

```yaml
deploy-job:
  stage: deploy
  script:
    - echo "Deploying to server"
    - scp -i $DEPLOY_KEY app user@server:/path/to/deploy
  environment:
    name: production
```

### 7. **Using Job Artifacts and Dependencies**
- **Artifacts**: Files generated by a job that can be passed to later jobs.
- **Dependencies**: Jobs can pass outputs to subsequent jobs using artifacts.

```yaml
build-job:
  stage: build
  script:
    - make build
  artifacts:
    paths:
      - build/

test-job:
  stage: test
```
{% endraw %}
